# ==========================================
# Plesk Git Deployment Configuration
# ==========================================
# This file configures automatic deployment from Git
# when you push to the repository in Plesk

# Install dependencies and build the project
onDeploy:
  - echo "ğŸš€ Starting deployment..."

  # Check Node.js version
  - echo "ğŸ“¦ Node.js version:"
  - node --version

  # Install pnpm if not available
  - echo "ğŸ“¦ Installing pnpm..."
  - npm install -g pnpm || true

  # Install dependencies
  - echo "ğŸ“¦ Installing dependencies..."
  - pnpm install --frozen-lockfile

  # Install root-level proxy dependencies
  - echo "ğŸ“¦ Installing proxy dependencies..."
  - npm install http-proxy --save

  # Setup environment files with production configuration
  - echo "ğŸ”§ Setting up environment..."
  - bash setup-env.sh

  # Generate Prisma client
  - echo "ğŸ—„ï¸ Generating Prisma client..."
  - cd apps/api && pnpm prisma generate && cd ../..

  # Build API
  - echo "ğŸ”¨ Building API..."
  - pnpm --filter api build

  # Build Web
  - echo "ğŸ”¨ Building Web..."
  - pnpm --filter web build

  # Create required directories
  - echo "ğŸ“ Creating required directories..."
  - mkdir -p uploads logs
  - chmod 755 uploads logs

  # Run database migrations (only if DB is configured)
  - echo "ğŸ—„ï¸ Running database migrations..."
  - cd apps/api && pnpm prisma migrate deploy || echo "âš ï¸ Migrations failed - make sure DATABASE_URL is configured" && cd ../..

  - echo "âœ… Deployment completed successfully!"
  - echo ""
  - echo "ğŸ“ Next steps:"
  - echo "1. Start applications: bash start.sh"
  - echo "2. Create admin user: cd apps/api && node scripts/create-admin.js"
  - echo "3. Check status: pm2 status"
  - echo "4. View logs: pm2 logs"

# Clean up unnecessary files
exclude:
  - .git
  - .github
  - node_modules
  - "*.log"
  - "*.md"
  - .env.example
  - .dockerignore
  - docker-compose.yml
  - pnpm-lock.yaml
