# Архитектура проекта Aimak Akshamy

## Обзор

Aimak Akshamy - это двуязычная (казахский/русский) система управления контентом для общественно-политического сетевого издания. Проект построен как монорепозиторий с двумя основными приложениями.

## Технологический стек

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENT LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│  Next.js 14 (App Router)  │  React 18  │  TailwindCSS 3.4      │
│  Zustand (state)          │  React Query 5  │  TipTap Editor   │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                          API LAYER                              │
├─────────────────────────────────────────────────────────────────┤
│  NestJS 10 (Express)  │  Swagger OpenAPI  │  Passport JWT      │
│  Class Validator      │  Multer (uploads) │  bcryptjs          │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                         DATA LAYER                              │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL 15  │  Redis 7  │  Prisma ORM 5.7  │  Supabase     │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      EXTERNAL SERVICES                          │
├─────────────────────────────────────────────────────────────────┤
│  OpenRouter AI  │  Telegram Bot API  │  Instagram Graph API    │
└─────────────────────────────────────────────────────────────────┘
```

## Структура монорепозитория

```
AIMAK/
├── apps/
│   ├── api/                    # NestJS Backend
│   │   ├── src/
│   │   │   ├── advertisements/ # Управление рекламой
│   │   │   ├── articles/       # Статьи + AI анализ
│   │   │   ├── auth/           # Аутентификация
│   │   │   ├── categories/     # Категории
│   │   │   ├── common/         # Общие модули
│   │   │   │   ├── prisma/     # ORM сервис
│   │   │   │   ├── supabase/   # Облачное хранилище
│   │   │   │   └── storage/    # Локальное хранилище
│   │   │   ├── health/         # Health check + PM2
│   │   │   ├── magazine-issues/# PDF журнал
│   │   │   ├── media/          # Загрузка файлов
│   │   │   ├── social-media/   # Telegram/Instagram
│   │   │   ├── tags/           # Теги + AI генерация
│   │   │   ├── translation/    # AI перевод
│   │   │   └── users/          # Пользователи
│   │   └── prisma/
│   │       ├── schema.prisma   # Схема БД
│   │       └── migrations/     # Миграции
│   │
│   └── web/                    # Next.js Frontend
│       └── src/
│           ├── app/            # App Router страницы
│           │   ├── [lang]/     # Мультиязычные маршруты
│           │   └── admin/      # Админ-панель
│           ├── components/     # React компоненты
│           │   ├── ui/         # UI библиотека
│           │   └── ...         # Специализированные
│           ├── hooks/          # Custom React хуки
│           ├── lib/            # Утилиты
│           ├── store/          # Zustand stores
│           └── types/          # TypeScript типы
│
├── docs/                       # Документация
├── scripts/                    # Утилиты и скрипты
├── docker-compose.yml          # Docker конфигурация
├── ecosystem.config.js         # PM2 конфигурация
└── pnpm-workspace.yaml         # Workspace конфиг
```

## Основные модули

### 1. Система статей (Articles)

Двуязычная система управления статьями с AI-функциями:
- Автоматический перевод (KZ ↔ RU)
- AI-категоризация контента
- Проверка орфографии
- Автопубликация в соцсети

### 2. Система аутентификации (Auth)

JWT-based аутентификация с ролями:
- **USER** - базовый пользователь
- **EDITOR** - создание/редактирование статей
- **ADMIN** - полный доступ

### 3. Медиа система (Media)

Гибридное хранилище файлов:
- Локальное хранилище (development)
- Supabase Storage (production)
- Автоматическая оптимизация изображений

### 4. Журнал (Magazine Issues)

Управление PDF-номерами журнала:
- Загрузка и хранение PDF
- Просмотр онлайн (PDF.js)
- Счетчики просмотров/загрузок

### 5. Социальные сети (Social Media)

Интеграция с платформами:
- **Telegram** - публикация через Bot API
- **Instagram** - публикация через Graph API
- **TikTok** - публикация и статистика (v2 API)
- Отслеживание статусов публикаций

### 6. Системное администрирование (System Admin)

Управление сервером через админ-панель:
- **PM2 мониторинг** - статус процессов, CPU, память
- **Перезапуск сервисов** - API и Web из интерфейса
- **Системные настройки** - переключатели конфигурации
- **Оптимизация изображений** - вкл/выкл серверной обработки

## Поток данных

```
┌────────────┐    HTTP/REST     ┌────────────┐
│   Client   │ ◄──────────────► │   API      │
│  (Next.js) │                  │  (NestJS)  │
└────────────┘                  └─────┬──────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
            ┌───────────┐     ┌───────────┐     ┌───────────┐
            │ PostgreSQL│     │   Redis   │     │ Supabase  │
            │  (данные) │     │   (кэш)   │     │ (файлы)   │
            └───────────┘     └───────────┘     └───────────┘
```

## Особенности реализации

### Двуязычность

Все контентные модели поддерживают два языка:
- Суффикс `Kz` - казахский язык (обязательный)
- Суффикс `Ru` - русский язык (опциональный)

```typescript
interface Article {
  titleKz: string;    // Обязательно
  contentKz: string;  // Обязательно
  titleRu?: string;   // Опционально
  contentRu?: string; // Опционально
}
```

### AI интеграция

OpenRouter API используется для:
- Перевод текста между KZ и RU
- Автоматическая категоризация статей
- Генерация тегов из контента
- Проверка орфографии

### Безопасность

- JWT токены с refresh механизмом
- Хеширование паролей (bcrypt)
- CORS защита
- Rate limiting
- Валидация входных данных

## Масштабирование

Архитектура поддерживает горизонтальное масштабирование:
- Stateless API серверы
- Redis для сессий и кэша
- PM2 кластеризация
- Отдельные сервисы БД
