# Руководство по локальному тестированию функции автопубликации в социальные сети

## Обзор

Этот документ содержит пошаговые инструкции для тестирования функции автоматической публикации статей в социальные сети (Telegram и Instagram) на локальном компьютере.

## Предварительные требования

### 1. Установленное ПО
- Node.js 18+ и pnpm
- PostgreSQL 14+
- Git

### 2. Учетные данные для социальных сетей

#### Telegram Bot
- Bot Token от @BotFather
- Chat ID канала (публичный username или приватный ID)

#### Instagram Business Account
- Access Token от Meta for Developers
- Instagram Business Account ID

## Шаг 1: Подготовка базы данных

### 1.1 Применение миграции

```bash
# Перейдите в директорию API
cd /home/user/AIMAK/apps/api

# Примените миграцию базы данных
pnpm prisma migrate dev

# Или если миграция уже применена, просто сгенерируйте клиент
pnpm prisma generate
```

### 1.2 Проверка таблиц

Подключитесь к базе данных и проверьте, что созданы следующие таблицы:
- `SocialMediaConfig` - конфигурации платформ
- `SocialMediaPublication` - история публикаций

```sql
-- Проверить структуру
\d "SocialMediaConfig"
\d "SocialMediaPublication"
```

## Шаг 2: Настройка Telegram Bot

### 2.1 Создание бота

1. Откройте Telegram и найдите **@BotFather**
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный **Bot Token** (формат: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`)

### 2.2 Настройка канала

1. Создайте тестовый канал в Telegram или используйте существующий
2. Добавьте бота в канал как администратора с правом публикации сообщений
3. Получите Chat ID:
   - Для **публичного канала**: используйте username (например, `@testchannel`)
   - Для **приватного канала**:
     - Перешлите сообщение из канала боту @userinfobot
     - Скопируйте полученный ID (например, `-1001234567890`)

## Шаг 3: Настройка Instagram (опционально)

### 3.1 Создание Facebook App

1. Перейдите на [developers.facebook.com](https://developers.facebook.com)
2. Создайте новое приложение
3. Добавьте продукт **Instagram Graph API**

### 3.2 Получение Access Token

1. В Graph API Explorer выберите ваш Instagram Business аккаунт
2. Запросите разрешения:
   - `instagram_basic`
   - `instagram_content_publish`
3. Сгенерируйте User Access Token
4. Обменяйте краткосрочный токен на долгосрочный:

```bash
curl -X GET "https://graph.facebook.com/v18.0/oauth/access_token?grant_type=fb_exchange_token&client_id={app-id}&client_secret={app-secret}&fb_exchange_token={short-lived-token}"
```

5. Получите Instagram Business Account ID:

```bash
curl -X GET "https://graph.facebook.com/v18.0/me/accounts?access_token={access-token}"
```

## Шаг 4: Запуск приложения

### 4.1 Запуск Backend

```bash
# В корневой директории проекта
cd /home/user/AIMAK

# Запустите API сервер
pnpm --filter @aimak/api dev
```

Backend должен запуститься на `http://localhost:3001`

### 4.2 Запуск Frontend (в новом терминале)

```bash
# В корневой директории проекта
cd /home/user/AIMAK

# Запустите веб-приложение
pnpm --filter @aimak/web dev
```

Frontend должен запуститься на `http://localhost:3000`

## Шаг 5: Настройка интеграций в админ-панели

### 5.1 Авторизация

1. Откройте браузер и перейдите на `http://localhost:3000`
2. Войдите в систему с правами ADMIN

### 5.2 Настройка Telegram

1. Перейдите в **Настройки** → **Социальные сети**
2. Выберите вкладку **Telegram**
3. Включите переключатель "Включить публикацию в Telegram"
4. Введите **Bot Token** (из Шага 2.1)
5. Введите **Chat ID** (из Шага 2.2)
6. Нажмите "Сохранить настройки Telegram"

### 5.3 Настройка Instagram (если настроен)

1. Выберите вкладку **Instagram**
2. Включите переключатель "Включить публикацию в Instagram"
3. Введите **Access Token** (из Шага 3.2)
4. Введите **Instagram Business Account ID** (из Шага 3.2)
5. Нажмите "Сохранить настройки Instagram"

## Шаг 6: Тестирование публикации

### 6.1 Создание тестовой статьи

1. Перейдите в **Статьи** → **Создать статью**
2. Заполните обязательные поля:
   - **Заголовок (KZ)**: Тестовая статья
   - **Заголовок (RU)**: Тестовая статья
   - **Содержание**: Любой тестовый контент
   - **Категория**: Выберите любую
   - **Обложка**: Загрузите изображение (обязательно для Instagram!)

### 6.2 Включение автопубликации

1. Прокрутите до раздела **"Автопубликация в социальные сети"**
2. Установите галочку **"Включить автопубликацию"**
3. Выберите платформы для публикации:
   - ✅ Telegram
   - ✅ Instagram (если настроен)
4. Проверьте **превью публикации** ниже

### 6.3 Публикация

1. Убедитесь, что статус статьи установлен на **"Опубликовано"**
2. Нажмите **"Создать статью"** или **"Сохранить изменения"**
3. Дождитесь завершения операции

## Шаг 7: Проверка результатов

### 7.1 Проверка в Telegram

1. Откройте ваш Telegram канал
2. Проверьте, что появился новый пост с:
   - Заголовком статьи
   - Описанием
   - Категорией
   - Тегами (хэштеги)
   - Ссылкой на статью
   - Изображением обложки (если есть)

### 7.2 Проверка в Instagram

1. Откройте ваш Instagram Business аккаунт
2. Проверьте, что появился новый пост с:
   - Изображением обложки
   - Подписью (caption) с заголовком и описанием
   - Хэштегами
   - Ссылкой на статью

### 7.3 Проверка истории публикаций

1. В админ-панели откройте созданную статью на редактирование
2. Прокрутите до раздела **"История публикаций в социальные сети"**
3. Проверьте статус публикаций:
   - ✅ **Успешно** - зеленый бадж с ID публикации
   - ❌ **Ошибка** - красный бадж с описанием ошибки

### 7.4 Проверка логов

Проверьте логи backend для детальной информации:

```bash
# Логи должны содержать:
# - "Publishing article {id} to platforms: Telegram, Instagram"
# - "Successfully published to TELEGRAM: {title}"
# - "Successfully published to INSTAGRAM: {title}"
```

## Шаг 8: Тестирование сценариев ошибок

### 8.1 Тест с неверным Bot Token

1. В настройках Telegram введите неверный Bot Token
2. Попробуйте опубликовать статью
3. **Ожидаемый результат**:
   - Статья создается
   - Публикация в Telegram помечена как "Ошибка"
   - Ошибка отображается в истории публикаций

### 8.2 Тест без обложки для Instagram

1. Создайте статью **без изображения обложки**
2. Включите автопубликацию только в Instagram
3. **Ожидаемый результат**:
   - Предупреждение в превью
   - Публикация помечена как "Ошибка"
   - Ошибка: "Instagram requires cover image"

### 8.3 Тест с отключенной платформой

1. В настройках отключите Telegram (выключите переключатель)
2. Попробуйте опубликовать статью с автопубликацией в Telegram
3. **Ожидаемый результат**:
   - Публикация помечена как "Ошибка"
   - Ошибка: "Telegram is not configured or disabled"

## Шаг 9: Проверка базы данных

### 9.1 Проверка конфигураций

```sql
SELECT * FROM "SocialMediaConfig";
```

Ожидаемый результат:
- 2 записи (TELEGRAM и INSTAGRAM)
- `enabled` = true для настроенных платформ
- Токены и ID сохранены (но не отображаются в явном виде)

### 9.2 Проверка публикаций

```sql
SELECT * FROM "SocialMediaPublication" ORDER BY "publishedAt" DESC;
```

Для каждой публикации проверьте:
- `platform` - TELEGRAM или INSTAGRAM
- `status` - SUCCESS или FAILED
- `externalId` - ID сообщения в соцсети (для успешных)
- `error` - текст ошибки (для неудачных)

## Шаг 10: Очистка тестовых данных (опционально)

```sql
-- Удалить тестовые публикации
DELETE FROM "SocialMediaPublication" WHERE "articleId" IN (
  SELECT id FROM "Article" WHERE "titleRu" LIKE '%Тест%'
);

-- Удалить тестовые статьи
DELETE FROM "Article" WHERE "titleRu" LIKE '%Тест%';

-- Сбросить конфигурации
UPDATE "SocialMediaConfig" SET enabled = false;
```

## Возможные проблемы и решения

### Проблема 1: Ошибка "Bad Request: chat not found"

**Причина**: Неверный Chat ID или бот не добавлен в канал

**Решение**:
- Проверьте, что бот добавлен в канал как администратор
- Проверьте правильность Chat ID
- Для приватного канала ID должен начинаться с `-100`

### Проблема 2: Instagram API возвращает ошибку токена

**Причина**: Истек срок действия Access Token

**Решение**:
- Обновите Access Token через Facebook Graph API Explorer
- Убедитесь, что используете долгосрочный токен (валидность 60 дней)

### Проблема 3: Изображение не загружается в Telegram

**Причина**: URL изображения недоступен для Telegram

**Решение**:
- Убедитесь, что изображение доступно публично по URL
- Проверьте, что URL начинается с `https://`
- Используйте абсолютный URL, а не относительный

### Проблема 4: TypeScript ошибки компиляции

**Причина**: Не сгенерирован Prisma Client или не установлены зависимости

**Решение**:
```bash
cd /home/user/AIMAK
pnpm install
pnpm exec prisma generate
```

## Контрольный список

### Перед тестированием
- [ ] База данных запущена
- [ ] Миграции применены
- [ ] Prisma Client сгенерирован
- [ ] Зависимости установлены
- [ ] Backend компилируется без ошибок
- [ ] Frontend компилируется без ошибок

### Telegram
- [ ] Bot создан в @BotFather
- [ ] Bot Token получен
- [ ] Канал создан
- [ ] Бот добавлен в канал как администратор
- [ ] Chat ID получен
- [ ] Конфигурация сохранена в админ-панели

### Instagram (опционально)
- [ ] Facebook App создано
- [ ] Instagram Graph API добавлен
- [ ] Access Token получен и обменян на долгосрочный
- [ ] Instagram Business Account ID получен
- [ ] Конфигурация сохранена в админ-панели

### Тестирование
- [ ] Тестовая статья создана с обложкой
- [ ] Автопубликация включена
- [ ] Платформы выбраны
- [ ] Превью отображается корректно
- [ ] Публикация прошла успешно
- [ ] Посты появились в социальных сетях
- [ ] История публикаций отображается
- [ ] Сценарии ошибок протестированы

## Дополнительные ресурсы

- [Telegram Bot API Documentation](https://core.telegram.org/bots/api)
- [Instagram Graph API Documentation](https://developers.facebook.com/docs/instagram-api)
- [Prisma Documentation](https://www.prisma.io/docs/)
- [NestJS Documentation](https://docs.nestjs.com/)
- [Next.js Documentation](https://nextjs.org/docs)

## Поддержка

Если возникли проблемы при тестировании:
1. Проверьте логи backend и frontend
2. Проверьте записи в таблице `SocialMediaPublication`
3. Убедитесь, что все учетные данные введены правильно
4. Проверьте сетевое подключение

---

**Готово к production:** После успешного локального тестирования можно переходить к развертыванию на production сервере.
