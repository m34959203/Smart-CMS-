# ==========================================
# AIMAK Nginx Configuration for Plesk
# ==========================================
# Copy this content to Plesk:
# Websites & Domains -> aimaqaqshamy.kz -> Apache & nginx Settings
# Paste into "Additional nginx directives" field
# ==========================================

# Proxy settings
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection 'upgrade';
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_cache_bypass $http_upgrade;
proxy_read_timeout 86400;

# API requests -> NestJS on port 4000
location /api {
    proxy_pass http://127.0.0.1:4000;
}

# WebSocket for API
location /socket.io {
    proxy_pass http://127.0.0.1:4000;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# Serve uploaded files
location /uploads {
    alias /var/www/vhosts/aimaqaqshamy.kz/httpdocs/uploads;
    expires 30d;
    add_header Cache-Control "public, immutable";
}

# Next.js static files
location /_next/static {
    proxy_pass http://127.0.0.1:3000;
    expires 365d;
    add_header Cache-Control "public, immutable";
}

# Next.js image optimization
location /_next/image {
    proxy_pass http://127.0.0.1:3000;
}

# All other requests -> Next.js on port 3000
location / {
    proxy_pass http://127.0.0.1:3000;
}
